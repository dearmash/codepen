<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" id="themeColor" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="plus.json">

  <title>NOT.ESP+</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      width: 100vw;
      font-family: 'Helvetica Neue', sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
    }

    html {
      overflow: hidden;
      height: 100vh;
    }

    button {
      padding: 16px 24px;
      margin: 10px 0;
      font-size: 18px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #444, #222);
      color: white;
      width: 80%;
      max-width: 300px;
      transition: transform 0.2s ease;
    }

    button:hover {
      transform: scale(1.02);
    }

    .backBtn {
      position: fixed;
      top: calc(20px + env(safe-area-inset-top));
      z-index: 2000;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #444, #222);
      color: white;
      font-size: 18px;
      padding: 12px 20px;
      transition: transform 0.2s ease;
    }

    .hidden {
      display: none !important;
    }

    #mainMenu, #customUI, #performanceUI {
      position: absolute;
      top: 0; left: 0;
      height: 100vh;
      width: 100vw;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }

    #mainMenu {
      display: flex;
      margin-top: -20px;
    }

    #customUI {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      height: 100vh;
      padding-top: 120px;
    }

    input, textarea {
      margin: 10px 0;
      padding: 12px;
      width: calc(100% - 40px);
      max-width: 360px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
    }

    #screenshotList {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 10px;
    }

    .screenshot-item {
      position: relative;
      margin: 8px;
    }

    .screenshot-item img {
      max-width: 100px;
      border-radius: 6px;
      border: 1px solid #555;
      cursor: pointer;
    }

    .delete-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      background: red;
      border: none;
      border-radius: 50%;
      font-size: 14px;
      color: white;
      width: 20px;
      height: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      line-height: 1;
    }

    /* NEW: gear (customise) button */
    .edit-btn {
      position: absolute;
      top: -6px;
      left: -6px;
      background: #666;
      border: none;
      border-radius: 50%;
      font-size: 14px;
      color: white;
      width: 20px;
      height: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      line-height: 1;
    }

    /* NEW: routine tiles */
    .routine-tile {
      margin: 8px;
      cursor: pointer;
    }

    .routine-tile-inner {
      background: linear-gradient(135deg, #444, #222);
      padding: 24px 32px;
      border-radius: 12px;
      font-size: 18px;
      text-transform: uppercase;
      white-space: nowrap;
      transition: transform 0.2s ease;
    }

    .routine-tile-inner:hover {
      transform: scale(1.03);
    }

    #fullImage {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100dvh;
      object-fit: cover;
      z-index: 9999;
      display: none;
      background-color: black;
    }

    #footer {
      position: absolute;
      bottom: calc(100px + env(safe-area-inset-bottom));
      text-align: center;
      font-size: 14px;
      opacity: 0.6;
    }

    a {
      color: #aaa;
      text-decoration: none;
    }

    .modal {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #111;
      border: 1px solid #444;
      padding: 20px;
      border-radius: 12px;
      z-index: 2000;
      width: 90%;
      max-width: 320px;
      box-shadow: 0 0 20px rgba(255,255,255,0.1);
      gap: 10px;
    }

    .modal label {
      font-size: 14px;
      margin-top: 10px;
      margin-bottom: 4px;
      align-self: flex-start;
      color: #ccc;
    }

    .modal input {
      width: 80%;
      padding: 8px;
      font-size: 14px;
      border-radius: 6px;
    }

    .modal button {
      font-size: 16px;
      padding: 10px 16px;
      width: 100%;
    }

    body.modal-open::before {
      content: '';
      position: fixed;
      inset: 0;
      backdrop-filter: blur(8px);
      background: rgba(0, 0, 0, 0.4);
      z-index: 1999;
    }

    #logoImage {
      width: auto;
      max-width: 100px;
      height: auto;
      margin-top: calc(20px + env(safe-area-inset-top));
      margin-bottom: 10px;
      display: block;
      margin-left: auto;
      margin-right: auto;
      opacity: 0.2;
    }
  </style>
</head>
<body>

  <div id="mainMenu">
    <img src="nrune.jpg" alt="Logo" id="logoImage">
    <div style="text-align:center; margin-bottom: 30px;">
      <h1 style="color: white; font-size: 52px; font-weight: lighter; text-shadow: 0 0 10px rgba(255,255,255,0.8); opacity: 0.8; margin: 0;">NOT.ESP+</h1>
      <small style="color: #ccc; font-size: 14px; font-weight: light; letter-spacing: 1px;">CUSTOM IMAGE FRAMEWORK</small>
    </div>
    <button onclick="showPerformance()">Start üí¨</button>
    <button onclick="showCustom()">Customise ‚öôÔ∏è</button>
    <div id="footer">
      Developed by<br>
      <strong>Jake Keane</strong><br>
      The NOT.ESP System<br>
      <a href="https://TruSecrets.com" target="_blank">TruSecrets.com</a>
    </div>
  </div>

  <div id="performanceUI">
    <button class="backBtn" onclick="goHome()">Back ‚Üê</button>
    <select id="routineSelector" style="margin-bottom: 20px; font-size: 20px; padding: 12px; width: 80%; max-width: 360px; border-radius: 12px;">
        <option value="">-- Choose Routine --</option>
      </select>      
    <textarea id="dictationBox" rows="4" placeholder="Click the microphone on your keyboard and start speaking..."></textarea>
  </div>

  <div id="customUI">
    <button class="backBtn" onclick="goHome()">Back ‚Üê</button>
    <button id="routineFolderBackBtn" class="backBtn hidden" style="top: calc(60px + env(safe-area-inset-top));" onclick="backToRoutines()">Back ‚Üê</button>

    <div id="screenshotList"></div>
    <button onclick="openAddModal()">Choose Image ‚ûï</button>
  </div>

  <img id="fullImage">
  <canvas id="colorCanvas" style="display:none;"></canvas>

  <!-- Main application script -->
  <script type="module">
  /* -------------------------------------------------------------
     NOT.ESP+ ‚Äî IndexedDB Edition (enhanced)
     ------------------------------------------------------------- */
  import { openDB } from 'https://cdn.jsdelivr.net/npm/idb@8/+esm';

  /* ---------------- IndexedDB bootstrap ----------------------- */
  const dbPromise = openDB('not-esp-plus', 1, {
    upgrade(db) {
      const store = db.createObjectStore('screenshots', {
        keyPath: 'id',
        autoIncrement: true
      });
      store.createIndex('codeword', 'codeword');
      store.createIndex('routine', 'routine');
    }
  });

  let db;               // resolved db instance
  let screenshots = []; // in-memory cache mirrored from IndexedDB
  let currentRoutine = null; // NEW: tracks the routine currently being viewed in Custom UI

  /* ---------------- Utility: legacy migration ------------------ */
  async function migrateLegacy() {
    const legacy = JSON.parse(localStorage.getItem('screenshots') || '[]');
    if (!legacy.length) return;
    const tx = db.transaction('screenshots', 'readwrite');
    for (const s of legacy) await tx.store.add(s);
    await tx.done;
    localStorage.removeItem('screenshots');
  }

  /* ---------------- CRUD wrappers ----------------------------- */
  async function refreshScreenshots() {
    screenshots = await db.getAll('screenshots');
  }

  async function addShot(record) {
    record.id = await db.add('screenshots', record);
    screenshots.push(record);
  }

  async function updateShot(id, patch) {
    const rec = await db.get('screenshots', id);
    Object.assign(rec, patch);
    await db.put('screenshots', rec);
    const i = screenshots.findIndex(r => r.id === id);
    screenshots[i] = rec;
  }

  async function deleteShot(id) {
    await db.delete('screenshots', id);
    screenshots = screenshots.filter(r => r.id !== id);
  }

  /* ---------------- DOM refs ----------------------------- */
  const fullImage      = document.getElementById('fullImage');
  const dictationBox   = document.getElementById('dictationBox');
  const screenshotList = document.getElementById('screenshotList');

  /* ---------------- Gesture to dismiss full-screen image -------- */
  let tapCount = 0;
  let tapTimer;
  fullImage.addEventListener('click', () => {
    tapCount++;
    if (tapCount === 3) {
      hideFullImage();
      tapCount = 0;
      clearTimeout(tapTimer);
    } else {
      clearTimeout(tapTimer);
      tapTimer = setTimeout(() => tapCount = 0, 500);
    }
  });

  /* ---------------- Render routines tiles ---------------------- */
  function renderRoutineTiles() {
    screenshotList.innerHTML = '';

    const routineMap = {};
    screenshots.forEach(s => {
      if (!s.routine) return;
      const key = s.routine.toLowerCase();
      if (!routineMap[key]) routineMap[key] = s.routine; // preserve original casing for display
    });

    const routineKeys = Object.keys(routineMap);

    if (!routineKeys.length) {
      screenshotList.innerHTML = '<p style="text-align:center;opacity:0.6;">No routines yet.</p>';
      return;
    }

    routineKeys.forEach(k => {
      const displayName = routineMap[k].toUpperCase();
      const wrapper = document.createElement('div');
      wrapper.className = 'routine-tile';
      wrapper.innerHTML = `<div class="routine-tile-inner">${displayName}</div>`;
      wrapper.onclick = () => openRoutine(routineMap[k]);
      screenshotList.appendChild(wrapper);
    });
  }

  /* ---------------- Render list ----------------------------- */
  function renderList() {
    screenshotList.innerHTML = '';
    const list = currentRoutine ? screenshots.filter(s => (s.routine || '').toLowerCase() === currentRoutine.toLowerCase()) : screenshots;

    list.forEach(s => {
      const masterIndex = screenshots.findIndex(r => r.id === s.id);
      const wrapper = document.createElement('div');
      wrapper.className = 'screenshot-item';

      const img = document.createElement('img');
      img.src   = s.data;
      img.title = `${s.name} (${s.codeword})`;
      img.onclick = () => openEditModal(masterIndex);

      const delBtn = document.createElement('button');
      delBtn.innerHTML = 'x';
      delBtn.className = 'delete-btn';
      delBtn.onclick = async (e) => {
        e.stopPropagation();
        if (confirm('Delete this image?')) {
          await deleteShot(s.id);
          if (currentRoutine) {
            renderList();
          } else {
            renderRoutineTiles();
          }
        }
      };

      /* NEW: customise (gear) button */
      const editBtn = document.createElement('button');
      editBtn.innerHTML = '‚öôÔ∏è';
      editBtn.className = 'edit-btn';
      editBtn.onclick = (e) => {
        e.stopPropagation();
        openEditModal(masterIndex);
      };

      wrapper.appendChild(img);
      wrapper.appendChild(editBtn);
      wrapper.appendChild(delBtn);
      screenshotList.appendChild(wrapper);
    });
  }

  /* ---------------- Hard scroll lock for full screen ----------- */
  function lockScrollHard() {
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
  }

  /* ---------------- Modal helpers ----------------------------- */
  function openEditModal(index) {
    document.body.classList.add('modal-open');
    const s = screenshots[index];
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <label>Name:</label><input id="editName" value="${s.name}">
      <label>Codeword:</label><input id="editCode" value="${s.codeword}">
      <label>Routine:</label><input id="editRoutine" value="${s.routine || ''}">
      <button onclick="applyEdit(${index})">Save</button>
      <button onclick="closeModal()">Cancel</button>
    `;
    document.body.appendChild(modal);
  }

  function openAddModal() {
    document.body.classList.add('modal-open');
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <label>Image File:</label>
      <input type="file" accept="image/*" id="modalImageInput">
      <label>Image Name:</label>
      <input type="text" id="modalNameInput" placeholder="Enter name">
      <label>Codeword:</label>
      <input type="text" id="modalCodewordInput" placeholder="Enter codeword">
      <label>Routine:</label>
      <input type="text" id="modalRoutineInput" placeholder="Enter routine">
      <button onclick="submitAddModal()">Save</button>
      <button onclick="closeModal()">Cancel</button>
    `;
    document.body.appendChild(modal);

    // pre‚Äëfill routine field if inside a routine folder
    document.getElementById('modalRoutineInput').value = currentRoutine || '';
  }

  function closeModal() {
    document.body.classList.remove('modal-open');
    document.querySelector('.modal')?.remove();
  }

  async function applyEdit(index) {
    const name    = document.getElementById('editName').value.trim();
    const code    = document.getElementById('editCode').value.trim().toLowerCase();
    const routine = document.getElementById('editRoutine').value.trim();
    if (!name || !code) return alert('All fields required.');
    await updateShot(screenshots[index].id, { name, codeword: code, routine });
    closeModal();
    if (currentRoutine) {
      renderList();
    } else {
      renderRoutineTiles();
    }
  }

  /* ---------------- Image save ----------------------------- */
  async function saveScreenshot() {
    const file     = document.getElementById('imageInput').files[0];
    const name     = document.getElementById('nameInput').value.trim();
    const codeword = document.getElementById('codewordInput').value.trim().toLowerCase();
    if (!file || !name || !codeword) return alert('All fields required');

    const reader = new FileReader();
    reader.onload = async (e) => {
      const imgData = e.target.result;
      await addShot({ name, codeword, data: imgData });
      if (currentRoutine) {
        renderList();
      } else {
        renderRoutineTiles();
      }
      setStatusBarColorFromImage(imgData);
      document.getElementById('imageInput').value  = '';
      document.getElementById('nameInput').value   = '';
      document.getElementById('codewordInput').value = '';
    };
    reader.readAsDataURL(file);
  }

  function submitAddModal() {
    const file     = document.getElementById('modalImageInput').files[0];
    const name     = document.getElementById('modalNameInput').value.trim();
    const codeword = document.getElementById('modalCodewordInput').value.trim().toLowerCase();
    const routine  = document.getElementById('modalRoutineInput').value.trim();

    if (!file || !name || !codeword) {
      alert('All fields required.');
      return;
    }

    const reader = new FileReader();
    reader.onload = async (e) => {
      const imgData = e.target.result;
      await addShot({ name, codeword, data: imgData, routine });
      if (currentRoutine) {
        renderList();
      } else {
        renderRoutineTiles();
      }
      setStatusBarColorFromImage(imgData);
      closeModal();
    };
    reader.readAsDataURL(file);
  }

  /* ---------------- Dictation listener ------------------------ */
  dictationBox.addEventListener('input', () => {
    const selectedRoutine = document.getElementById('routineSelector').value;
    const text = dictationBox.value.toLowerCase();

    for (let s of screenshots) {
      if ((!selectedRoutine || s.routine === selectedRoutine) &&
          text.includes(s.codeword)) {
        showImage(s.data);
        dictationBox.blur();
        break;
      }
    }
  });

  /* ---------------- Routine selection in performance UI -------- */
  function populateRoutineSelector() {
    const selector = document.getElementById('routineSelector');
    selector.innerHTML = '<option value="">-- Choose Routine --</option>';

    const routineMap = {};
    screenshots.forEach(s => {
      if (!s.routine) return;
      const lower = s.routine.toLowerCase();
      if (!routineMap[lower]) routineMap[lower] = s.routine; // keep first seen casing
    });

    Object.values(routineMap).forEach(r => {
      const opt = document.createElement('option');
      opt.value = r;
      opt.textContent = r.toUpperCase();
      selector.appendChild(opt);
    });
  }

  /* ---------------- Image display helpers -------------------- */
  function showImage(dataURL) {
    fullImage.src = dataURL;
    fullImage.style.display = 'block';
    lockScrollHard();
    dictationBox.value = '';
    setStatusBarColorFromImage(dataURL);
    document.querySelectorAll('.backBtn').forEach(btn => btn.classList.add('hidden'));
  }

  function hideFullImage() {
    fullImage.style.display = 'none';
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000000');
    document.querySelectorAll('.backBtn').forEach(btn => btn.classList.remove('hidden'));
    goHome();
  }

  /* ---------------- UI navigation ---------------------------- */
  function openRoutine(routineName) {
    currentRoutine = routineName;
    renderList();
    document.getElementById('customHomeBackBtn').classList.add('hidden');   // ‚Üê add this
    document.getElementById('routineFolderBackBtn').classList.remove('hidden');
  }

  function backToRoutines() {
    currentRoutine = null;
      document.getElementById('customHomeBackBtn').classList.remove('hidden'); // ‚Üê add this
    document.getElementById('routineFolderBackBtn').classList.add('hidden');
    renderRoutineTiles();
  }

  function showPerformance() {
    lockScroll();
    document.getElementById('mainMenu').style.display = 'none';
    document.getElementById('performanceUI').style.display = 'flex';
    populateRoutineSelector();
    dictationBox.value = '';
    dictationBox.focus();
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000000');
    document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]')?.setAttribute('content', 'black-translucent');
  }

  function showCustom() {
    document.getElementById('mainMenu').style.display = 'none';
    document.getElementById('customUI').style.display = 'flex';
    currentRoutine = null;
    document.getElementById('routineFolderBackBtn').classList.add('hidden');
    renderRoutineTiles();
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000000');
    document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]')?.setAttribute('content', 'black-translucent');
  }

  function goHome() {
    lockScroll();
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000000');
    document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]')?.setAttribute('content', 'black-translucent');
    document.getElementById('performanceUI').style.display = 'none';
    document.getElementById('customUI').style.display      = 'none';
    document.getElementById('mainMenu').style.display      = 'flex';
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000000');
    document.querySelectorAll('.backBtn').forEach(btn => btn.classList.remove('hidden'));
  }

  /* ---------------- Misc helpers ----------------------------- */
  function setStatusBarColorFromImage(dataURL) {
    const canvas = document.getElementById('colorCanvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    img.onload = function () {
      const width = img.width;
      const height = Math.min(50, img.height);
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(img, 0, 0, width, height);

      const imageData = ctx.getImageData(0, 0, width, height).data;
      let r = 0, g = 0, b = 0, count = 0;
      for (let i = 0; i < imageData.length; i += 4) {
        r += imageData[i];
        g += imageData[i + 1];
        b += imageData[i + 2];
        count++;
      }
      r = Math.round(r / count);
      g = Math.round(g / count);
      b = Math.round(b / count);

      const metaTag = document.querySelector('meta[name="theme-color"]');
      metaTag.setAttribute('content', '#00000000');
      document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]')?.setAttribute('content', 'black-translucent');
    };
    img.src = dataURL;
  }


  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/service-worker.js", { scope: "/" })
      .then(() => console.log("Service Worker Registered"))
      .catch((error) => console.error("Service Worker Registration Failed", error));
  }

  function lockScroll() {
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
  }

  /* ---------------- expose globals for inline handlers -------- */
  window.showPerformance = showPerformance;
  window.showCustom      = showCustom;
  window.goHome          = goHome;
  window.saveScreenshot  = saveScreenshot;
  window.openEditModal   = openEditModal;
  window.closeModal      = closeModal;
  window.applyEdit       = applyEdit;
  window.openAddModal    = openAddModal;
  window.submitAddModal  = submitAddModal;
  window.backToRoutines  = backToRoutines;

  /* ---------------- boot sequence ---------------------------- */
  (async () => {
    db = await dbPromise;
    await migrateLegacy();
    await refreshScreenshots();
    renderRoutineTiles();
    if (screenshots.length) {
      setStatusBarColorFromImage(screenshots[screenshots.length - 1].data);
    }
  })();
  </script>
</body>
</html>
